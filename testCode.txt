#include "main.h"
#include <stdio.h>
#include <string.h>

/* USER CODE BEGIN PV */
extern I2C_HandleTypeDef hi2c1;
extern UART_HandleTypeDef huart2;

/* Simple debug UART print functions */
void debug_print(char *s) {
    HAL_UART_Transmit(&huart2, (uint8_t*)s, strlen(s), HAL_MAX_DELAY);
}
void debug_println(char *s) {
    debug_print(s);
    debug_print("\r\n");
}

/* --- I2C scanner ---------------------------------------------------------- */
void I2C_Scan() {
    debug_println("Scanning I2C bus...");

    char msg[64];
    for(uint8_t addr = 1; addr < 127; addr++) {
        if (HAL_I2C_IsDeviceReady(&hi2c1, addr << 1, 1, 10) == HAL_OK) {
            snprintf(msg, sizeof(msg), " - Found device at 0x%02X", addr);
            debug_println(msg);
        }
    }
    debug_println("Scan complete.\r\n");
}

/* --- INA219 definitions --------------------------------------------------- */
#define INA219_ADDR1     (0x40 << 1)
#define INA219_ADDR2     (0x41 << 1)

#define INA219_REG_CONFIG       0x00
#define INA219_REG_SHUNT_V      0x01
#define INA219_REG_BUS_V        0x02
#define INA219_REG_POWER        0x03
#define INA219_REG_CURRENT      0x04
#define INA219_REG_CALIBRATION  0x05

uint16_t INA219_CalibrationValue = 4096;  // suitable for 0.1Ω shunt
float INA219_Current_LSB = 0.0001f;       // 100µA/bit
float INA219_Power_LSB   = 0.002f;        // 2mW/bit

HAL_StatusTypeDef INA_WriteReg(uint16_t addr, uint8_t reg, uint16_t val) {
    uint8_t data[3] = {reg, val >> 8, val & 0xFF};
    return HAL_I2C_Master_Transmit(&hi2c1, addr, data, 3, HAL_MAX_DELAY);
}

HAL_StatusTypeDef INA_ReadReg(uint16_t addr, uint8_t reg, uint16_t *val) {
    HAL_I2C_Master_Transmit(&hi2c1, addr, &reg, 1, HAL_MAX_DELAY);
    uint8_t buf[2];
    HAL_I2C_Master_Receive(&hi2c1, addr, buf, 2, HAL_MAX_DELAY);
    *val = (buf[0] << 8) | buf[1];
    return HAL_OK;
}

void INA_Init(uint16_t addr) {
    INA_WriteReg(addr, INA219_REG_CALIBRATION, INA219_CalibrationValue);

    uint16_t config = 0;
    config |= (1 << 13);   // 32V range
    config |= (3 << 11);   // gain 320mV
    config |= (3 << 7);    // bus ADC 12-bit
    config |= (3 << 3);    // shunt ADC 12-bit
    config |= 7;           // continuous shunt+bus
    INA_WriteReg(addr, INA219_REG_CONFIG, config);
}

void INA_Read(uint16_t addr, float *voltage, float *current, float *power) {
    uint16_t raw;

    // bus voltage
    INA_ReadReg(addr, INA219_REG_BUS_V, &raw);
    *voltage = ((raw >> 3) * 0.004f);

    // current
    INA_ReadReg(addr, INA219_REG_CURRENT, &raw);
    *current = ((int16_t)raw) * INA219_Current_LSB;

    // power
    INA_ReadReg(addr, INA219_REG_POWER, &raw);
    *power = raw * INA219_Power_LSB;
}

/* --- SSD1306 OLED (simple demo) ------------------------------------------ */
#define OLED_ADDR (0x3C << 1)

void OLED_Cmd(uint8_t cmd) {
    uint8_t data[2] = {0x00, cmd};
    HAL_I2C_Master_Transmit(&hi2c1, OLED_ADDR, data, 2, HAL_MAX_DELAY);
}

void OLED_Init() {
    HAL_Delay(100);
    OLED_Cmd(0xAE);
    OLED_Cmd(0x20); OLED_Cmd(0x00);
    OLED_Cmd(0xB0);
    OLED_Cmd(0xC8);
    OLED_Cmd(0x00);
    OLED_Cmd(0x10);
    OLED_Cmd(0x40);
    OLED_Cmd(0x81); OLED_Cmd(0x7F);
    OLED_Cmd(0xA1);
    OLED_Cmd(0xA6);
    OLED_Cmd(0xA8); OLED_Cmd(0x3F);
    OLED_Cmd(0xA4);
    OLED_Cmd(0xD3); OLED_Cmd(0x00);
    OLED_Cmd(0xD5); OLED_Cmd(0x80);
    OLED_Cmd(0xD9); OLED_Cmd(0xF1);
    OLED_Cmd(0xDA); OLED_Cmd(0x12);
    OLED_Cmd(0xDB); OLED_Cmd(0x40);
    OLED_Cmd(0x8D); OLED_Cmd(0x14);
    OLED_Cmd(0xAF);
}

void OLED_TestBar() {
    uint8_t rowData[128];
    memset(rowData, 0xFF, sizeof(rowData));

    // draw bar on page 3
    OLED_Cmd(0xB3);
    OLED_Cmd(0x00);
    OLED_Cmd(0x10);
    HAL_I2C_Mem_Write(&hi2c1, OLED_ADDR, 0x40, 1, rowData, 128, HAL_MAX_DELAY);
}

/* --- ESP-01S AT test ------------------------------------------------------ */
void ESP_Test() {
    char *cmd = "AT\r\n";
    debug_println("Sending ESP-01S AT command...");
    HAL_UART_Transmit(&huart2, (uint8_t*)cmd, strlen(cmd), HAL_MAX_DELAY);
}

/* --- MAIN ----------------------------------------------------------------- */
int main(void)
{
    HAL_Init();
    SystemClock_Config();

    MX_GPIO_Init();
    MX_I2C1_Init();
    MX_USART2_UART_Init();

    debug_println("==== FULL SYSTEM TEST START ====");

    /* 1. I2C Scan */
    I2C_Scan();

    /* 2. Initialize INA219 modules */
    debug_println("Initializing INA219 #1...");
    INA_Init(INA219_ADDR1);

    debug_println("Initializing INA219 #2...");
    INA_Init(INA219_ADDR2);

    /* 3. Initialize OLED */
    debug_println("Initializing OLED...");
    OLED_Init();
    OLED_TestBar();

    /* 4. Test ESP module */
    ESP_Test();

    /* Main loop: read INA219s and print continuously */
    while (1)
    {
        float v1, i1, p1;
        float v2, i2, p2;
        char msg[128];

        INA_Read(INA219_ADDR1, &v1, &i1, &p1);
        INA_Read(INA219_ADDR2, &v2, &i2, &p2);

        snprintf(msg, sizeof(msg),
                 "INA1: %.2f V  %.3f A  %.3f W | INA2: %.2f V  %.3f A  %.3f W\r\n",
                 v1, i1, p1,
                 v2, i2, p2);

        debug_print(msg);

        HAL_Delay(500);
    }
}
